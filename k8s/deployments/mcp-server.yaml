apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-server
  namespace: search-infrastructure
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mcp-server
  template:
    metadata:
      labels:
        app: mcp-server
    spec:
      # Image pull secret for Docker Hub private images
      # Using same secret pattern as other namespaces (docker4zerocool-registry-secret)
      imagePullSecrets:
      - name: docker-registry-secret
      containers:
      - name: mcp-server
        # TODO: Update with Docker Hub registry after PAT validation
        # Image: docker4zerocool/mcp-search-server:latest
        image: docker4zerocool/mcp-search-server:latest
        ports:
        - containerPort: 3000
        env:
        # Service URLs (internal cluster DNS)
        - name: SEARXNG_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: SEARXNG_URL
        - name: CRAWL4AI_URL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: CRAWL4AI_URL
        
        # Redis Connection - Using existing Redis Enterprise MCP database
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: REDIS_HOST
        - name: REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: REDIS_PORT
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redb-mcp-database
              key: password
        # Note: REDIS_URL construction from env vars is not supported in Kubernetes
        # Application should construct URL from REDIS_HOST, REDIS_PORT, REDIS_PASSWORD
        # Format: redis://:<password>@<host>:<port>
        # If application requires REDIS_URL, use an init container or entrypoint script
        
        # PostgreSQL Connection - Using existing CNPG cluster
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_PORT
        - name: DB_NAME
          valueFrom:
            secretKeyRef:
              name: pg-ceph-app
              key: dbname
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: pg-ceph-app
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: pg-ceph-app
              key: password
        # Full connection string (alternative to individual vars)
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: pg-ceph-app
              key: uri
        
        # Application Configuration
        - name: NODE_ENV
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: NODE_ENV
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: LOG_LEVEL
        - name: CACHE_TTL_SEARCH
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: CACHE_TTL_SEARCH
        - name: CACHE_TTL_CRAWL
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: CACHE_TTL_CRAWL
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        # MCP Server runs on stdio - keep stdin open to prevent exit
        stdin: true
        tty: false
        # Health is checked via process running status
        livenessProbe:
          exec:
            command: ["/bin/sh", "-c", "ps aux | grep -v grep | grep 'node dist/index.js' || exit 1"]
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command: ["/bin/sh", "-c", "ps aux | grep -v grep | grep 'node dist/index.js' || exit 1"]
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
